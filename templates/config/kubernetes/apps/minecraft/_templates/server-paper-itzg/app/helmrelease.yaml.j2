---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app REPLACE_ME_SERVER
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: REPLACE_ME_SERVER
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    deploymentAnnotations:
      configmap.reloader.stakater.com/reload: REPLACE_ME_SERVER-prometheus-exporter-config

    # itzg `minecraft` chart expects `extraVolumes` entries containing BOTH `volumes` and `volumeMounts`.
    extraVolumes:
      - volumeMounts:
          - name: prometheus-exporter-config
            mountPath: /data/plugins/PrometheusExporter/config.yml
            subPath: config.yml
            readOnly: true
        volumes:
          - name: prometheus-exporter-config
            configMap:
              name: REPLACE_ME_SERVER-prometheus-exporter-config
              items:
                - key: config.yml
                  path: config.yml
      # Optional: mount `/config` from a Secret (e.g. for `paper-global.yml` overrides)
      # - volumeMounts:
      #     - name: server-config
      #       mountPath: /config
      #       readOnly: true
      #   volumes:
      #     - name: server-config
      #       secret:
      #         secretName: *app

    image:
      repository: ghcr.io/itzg/minecraft-server
      tag: 2025.12.0-java21

    # Keep memory sizing here; CPU limits are intentionally omitted.
    resources:
      requests:
        cpu: 2
        memory: &memory 8G

    extraEnv:
      TZ: "America/Toronto"
      ENABLE_ROLLING_LOGS: true
      INIT_MEMORY: 1G
      MAX_MEMORY: *memory

    minecraftServer:
      eula: true
      # Pin exact version; bump when you upgrade clients.
      version: 1.21.11
      type: PAPER
      onlineMode: true
      difficulty: normal
      ops: "REPLACE_ME_OPS"
      worldSaveName: world
      overrideServerProperties: true

      # Install the PrometheusExporter plugin (Paper performance metrics: `mc_*`).
      pluginUrls:
        - https://github.com/sladkoff/minecraft-prometheus-exporter/releases/download/v3.1.2/minecraft-prometheus-exporter-3.1.2.jar

      # Optional: expose BlueMap and manage it with an HTTPRoute.
      # extraPorts:
      #   - name: bluemap
      #     containerPort: 8100
      #     protocol: TCP
      #     service:
      #       enabled: true
      #       type: ClusterIP
      #       port: 8100

      # Optional: enable RCON; pair with app/externalsecret.yaml and set an IP if you want a LAN LoadBalancer.
      # rcon:
      #   enabled: true
      #   port: 25577
      #   existingSecret: *app
      #   serviceType: LoadBalancer
      #   externalTrafficPolicy: Cluster

    # mc-router hostname-based routing
    serviceAnnotations:
      mc-router.itzg.me/externalServerName: "REPLACE_ME_SERVER.${SECRET_DOMAIN}"

    # Persistence is handled by an existing PVC (typically created by Volsync component for this app name).
    persistence:
      dataDir:
        enabled: true
        existingClaim: *app


