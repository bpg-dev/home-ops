---
# this job should not be included in the kustomization.yaml file by default
# yaml-language-server: $schema=https://raw.githubusercontent.com/yannh/kubernetes-json-schema/master/v1.30.0/job.json
apiVersion: batch/v1
kind: Job
metadata:
  name: import-world-s3
spec:
  ttlSecondsAfterFinished: 3600
  backoffLimit: 1
  template:
    metadata:
      labels:
        app.kubernetes.io/name: import-world-s3
    spec:
      restartPolicy: Never
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
      containers:
        - name: import
          image: ghcr.io/onedr0p/alpine:3.20.3
          command: ["sh", "-lc"]
          args:
            - |
              set -eu
              apk add --no-cache unzip aws-cli

              # Idempotent: skip import if world already exists.
              if [ -d /data/world/region ]; then
                echo "World already present at /data/world; skipping."
                exit 0
              fi

              : "${AWS_ENDPOINT_URL:?AWS_ENDPOINT_URL is required}"
              : "${AWS_REGION:?AWS_REGION is required}"
              : "${S3_BUCKET:?S3_BUCKET is required}"
              : "${S3_KEY:?S3_KEY is required}"

              # Garage is S3-compatible; force path-style requests for widest compatibility.
              export AWS_EC2_METADATA_DISABLED=true
              export AWS_S3_FORCE_PATH_STYLE=true

              rm -rf /tmp/unzip
              mkdir -p /tmp/unzip /data/world

              echo "Downloading ZIP from Garage..."
              aws s3 cp \
                --endpoint-url "$AWS_ENDPOINT_URL" \
                "s3://$S3_BUCKET/$S3_KEY" \
                /tmp/world.zip

              echo "Unzipping to staging..."
              unzip -q /tmp/world.zip -d /tmp/unzip

              echo "Normalizing ZIP layout into /data/world..."
              if [ -d /tmp/unzip/world ]; then
                cp -a /tmp/unzip/world/. /data/world/
              else
                cp -a /tmp/unzip/. /data/world/
              fi

              if [ ! -d /data/world/region ]; then
                echo "ERROR: import completed but /data/world/region is missing."
                echo "Check your ZIP structure (it must contain a valid Minecraft world)."
                exit 1
              fi

              echo "Import complete."
          envFrom:
            - secretRef:
                name: import-world-s3
          volumeMounts:
            - name: data
              mountPath: /data
            - name: tmp
              mountPath: /tmp
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
      volumes:
        # Mount the NEW server's PVC here.
        # Replace `REPLACE_ME_PVC_NAME` with the claim name for the server you're importing into.
        - name: data
          persistentVolumeClaim:
            claimName: REPLACE_ME_PVC_NAME
        - name: tmp
          emptyDir: {}


