---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: couchdb
spec:
  chart:
    spec:
      chart: couchdb
      sourceRef:
        kind: HelmRepository
        name: couchdb
      version: "4.6.2"
  interval: 1h
  # Give first install/upgrade more time (StatefulSet + PVC provisioning + cluster init).
  timeout: 10m
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      # The first successful install may not exist yet, making rollback impossible.
      # Uninstall+reinstall is the most reliable remediation for a first successful deploy.
      strategy: uninstall
      retries: 3
  values:
    # Create a 3-node CouchDB cluster. CouchDB sharding/replication (q/n) is per-database;
    # configure new DBs with n=3 to keep 2 replicas after a single node failure.
    clusterSize: 3

    allowAdminParty: false
    createAdminSecret: false
    extraSecretName: couchdb-secret

    # Required by couchdb-helm chart: a stable cluster UUID (generate once and keep fixed).
    couchdbConfig:
      couchdb:
        uuid: a077b304-3993-40d6-9861-6a5ef0a588f8
      chttpd:
        bind_address: any

    # Persist each CouchDB node's data to its own PVC (StatefulSet volumeClaimTemplate).
    persistentVolume:
      enabled: true
      accessModes: [ReadWriteOnce]
      storageClass: ceph-rbd
      size: 10Gi

    # Keep pods on separate Kubernetes nodes so a single node failure doesn't take down the cluster.
    affinity:
      podAntiAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
                - key: app
                  operator: In
                  values: [couchdb]
            topologyKey: kubernetes.io/hostname

    podDisruptionBudget:
      enabled: true
      maxUnavailable: 1

    # We'll manage NetworkPolicy explicitly (see networkpolicy.yaml) to keep ingress tight.
    networkPolicy:
      enabled: false

    # Finish the cluster automatically after install/upgrade. Pin the curl image tag (no 'latest').
    autoSetup:
      enabled: true
      image:
        repository: curlimages/curl
        tag: 8.14.1
        pullPolicy: IfNotPresent
      defaultDatabases:
        - _global_changes

    # Pod/container security context: rootless + drop all capabilities.
    podSecurityContext:
      runAsNonRoot: true
      # CouchDB official image runs as user/group 5984 ("couchdb") and needs write access
      # under /opt/couchdb (e.g., to write the Erlang cookie).
      runAsUser: 5984
      runAsGroup: 5984
      fsGroup: 5984
      fsGroupChangePolicy: OnRootMismatch
    containerSecurityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: false
      capabilities:
        drop: [ALL]

    # Expose the exporter port via the client Service and run exporter as a sidecar.
    service:
      extraPorts:
        - name: metrics
          port: 9984
          protocol: TCP
          targetPort: 9984

    sidecars:
      - name: metrics
        image: docker.io/gesellix/couchdb-prometheus-exporter:v30.4.2
        imagePullPolicy: IfNotPresent
        env:
          - name: COUCHDB_URI
            value: http://localhost:5984
          - name: COUCHDB_USERNAME
            valueFrom:
              secretKeyRef:
                name: couchdb-secret
                key: COUCHDB_USER
          - name: COUCHDB_PASSWORD
            valueFrom:
              secretKeyRef:
                name: couchdb-secret
                key: COUCHDB_PASSWORD
          - name: TELEMETRY_ADDRESS
            value: 0.0.0.0:9984
          - name: TELEMETRY_ENDPOINT
            value: /metrics
        ports:
          - name: metrics
            containerPort: 9984
            protocol: TCP
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop: [ALL]
        resources:
          requests:
            cpu: 10m
            memory: 64Mi
          limits:
            memory: 128Mi

    resources:
      requests:
        cpu: 50m
        memory: 256Mi
      limits:
        memory: 1Gi


