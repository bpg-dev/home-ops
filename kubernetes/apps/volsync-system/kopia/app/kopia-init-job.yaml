---
# yaml-language-server: $schema=https://raw.githubusercontent.com/yannh/kubernetes-json-schema/master/master-standalone-strict/job-batch-v1.json
# this job should not be included in the kustomization.yaml file
apiVersion: batch/v1
kind: Job
metadata:
  name: kopia-repository-init
  labels:
    app.kubernetes.io/name: kopia-repository-init
spec:
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        app.kubernetes.io/name: kopia-repository-init
    spec:
      restartPolicy: OnFailure
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
      containers:
        - name: kopia-init
          image: ghcr.io/home-operations/kopia:0.22.3@sha256:eeebd12fd4b3a9c25b9f711fff32454f62e2d5e2d431ab6806ad21c52f414807
          command:
            - /bin/sh
            - -c
            - |
              set -e
              echo "Checking if repository exists..."
              # Try to connect to existing repository first
              if kopia repository connect filesystem --path /repository --config-file /config/repository.config --password "$KOPIA_PASSWORD" 2>/dev/null; then
                echo "Repository already exists and is valid, skipping initialization"
                exit 0
              fi
              echo "No valid repository found. Checking for existing data..."
              if [ "$(ls -A /repository 2>/dev/null)" ]; then
                echo "WARNING: Found existing data in /repository. This may be leftover files."
                echo "Attempting to create repository (will fail if data conflicts)..."
              fi
              echo "Initializing repository at /repository..."
              kopia repository create filesystem \
                --path /repository \
                --config-file /config/repository.config \
                --password "$KOPIA_PASSWORD" || {
                echo "ERROR: Failed to create repository. If there's existing data, you may need to:"
                echo "1. Backup and remove existing files from /mnt/tank/nfs/volsync-kopia on the NAS"
                echo "2. Or manually initialize the repository"
                exit 1
              }
              echo "Repository initialized successfully!"
          env:
            - name: KOPIA_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: kopia-secret
                  key: KOPIA_PASSWORD
          volumeMounts:
            - name: config-file
              mountPath: /config/repository.config
              subPath: repository.config
              readOnly: true
            - name: repository
              mountPath: /repository
            - name: tmpfs
              mountPath: /tmp
              subPath: tmp
            - name: tmpfs
              mountPath: /config/cache
              subPath: cache
            - name: tmpfs
              mountPath: /config/logs
              subPath: logs
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
      volumes:
        - name: config-file
          configMap:
            name: kopia
        - name: repository
          nfs:
            server: nas.internal
            path: /mnt/tank/nfs/volsync-kopia
        - name: tmpfs
          emptyDir: {}

