---
# ExternalSecret for VolSync Kopia repository
# Shared by all PostgreSQL instance backups
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: postgres-volsync
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: postgres-volsync-secret
    template:
      data:
        KOPIA_FS_PATH: /repository
        KOPIA_PASSWORD: "{{ .KOPIA_PASSWORD }}"
        KOPIA_REPOSITORY: filesystem:///repository
  dataFrom:
    - extract:
        key: volsync-template

---
# ExternalSecret for CloudNativePG S3 backup credentials
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: postgres-backup-credentials
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: postgres-backup-credentials
  data:
    - secretKey: ACCESS_KEY_ID
      remoteRef:
        key: postgres/s3-access-key-id
    - secretKey: SECRET_ACCESS_KEY
      remoteRef:
        key: postgres/s3-secret-access-key

---
# ExternalSecret for PostgreSQL superuser (postgres) password
# CloudNativePG requires a Secret with username and password keys
# The secret will be created as kubernetes.io/basic-auth type
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: postgres-superuser
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: postgres-superuser
  template:
    type: kubernetes.io/basic-auth
    data:
      username: "{{ .username }}"
      password: "{{ .password }}"
  data:
    - secretKey: username
      remoteRef:
        key: postgres/superuser-username
    - secretKey: password
      remoteRef:
        key: postgres/superuser-password

