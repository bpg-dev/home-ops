groups:
  - name: loki.rules
    rules:
      - alert: LokiHasWarnOrErrorLogs
        expr: |
          sum by (pod) (
            count_over_time({job="fluent-bit", namespace="observability", pod=~"loki.*"} |~ "(?i)\\blevel=(warn|error)\\b"[5m])
          ) > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: Loki has warning/error logs (pod={{ $labels.pod }})
          description: |
            Loki pod {{ $labels.pod }} has emitted warning/error logs in the last 5 minutes.

      - alert: FluentBitHasWarnOrErrorLogs
        expr: |
          sum by (pod) (
            count_over_time({job="fluent-bit", namespace="observability", pod=~"fluent-bit.*"} |~ "(?i)\\blevel=(warn|error)\\b"[5m])
          ) > 0
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: Fluent Bit has warning/error logs (pod={{ $labels.pod }})
          description: |
            Fluent Bit pod {{ $labels.pod }} has emitted warning/error logs in the last 5 minutes.

      - alert: AppHighErrorRate
        expr: |
          sum by (namespace, app) (
            count_over_time({job="fluent-bit"} | json | level=~"error|fatal" [15m])
          ) > 50
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High error rate in {{ $labels.app }} ({{ $labels.namespace }})"
          description: |
            Application {{ $labels.app }} in namespace {{ $labels.namespace }} has produced
            more than 50 error/fatal log entries in the last 15 minutes.

      - alert: CriticalNamespaceErrors
        expr: |
          sum by (namespace, pod) (
            count_over_time({job="fluent-bit", namespace=~"kube-system|flux-system|cert-manager|network"} | json | level=~"error|fatal" [15m])
          ) > 20
        for: 10m
        labels:
          severity: critical
        annotations:
          summary: "Persistent errors in critical namespace {{ $labels.namespace }}"
          description: |
            Pod {{ $labels.pod }} in critical namespace {{ $labels.namespace }} has been producing
            error/fatal logs persistently.
