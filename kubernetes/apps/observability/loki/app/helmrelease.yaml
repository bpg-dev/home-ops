---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: loki
spec:
  chartRef:
    kind: OCIRepository
    name: loki
  interval: 1h
  values:
    fullnameOverride: loki

    controllers:
      loki:
        # HA mode: use RollingUpdate with memberlist ring KV store
        # Memberlist allows multiple pods to coordinate without shared storage
        replicas: 3
        strategy: RollingUpdate
        annotations:
          reloader.stakater.com/auto: "true"
        containers:
          app:
            image:
              repository: docker.io/grafana/loki
              tag: 3.6.7
            args:
              - -target=all
              - -config.file=/etc/loki/config.yaml
              - -config.expand-env=true
            env:
              - name: POD_IP
                valueFrom:
                  fieldRef:
                    fieldPath: status.podIP
            envFrom:
              - secretRef:
                  name: loki-secret
            probes:
              startup: &startup
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /ready
                    port: &port 3100
                  initialDelaySeconds: 30  # Give Loki time to start components
                  periodSeconds: 10  # Check every 10 seconds
                  timeoutSeconds: 2  # Allow 2 seconds for response
                  failureThreshold: 60  # Allow up to 10 minutes for startup (60 * 10s)
              liveness: &probes
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /ready
                    port: *port
                  initialDelaySeconds: 120  # Wait for startup probe to succeed first (2 minutes)
                  periodSeconds: 30  # Check less frequently once started
                  timeoutSeconds: 2
                  failureThreshold: 3
              readiness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /ready
                    port: *port
                  initialDelaySeconds: 30  # Start checking readiness after 30s
                  periodSeconds: 10
                  timeoutSeconds: 2
                  failureThreshold: 30  # Allow up to 5 minutes for readiness (30 * 10s)
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities:
                drop:
                  - ALL
            resources:
              requests:
                cpu: 100m
                memory: 512Mi
              limits:
                memory: 1Gi

    defaultPodOptions:
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
      affinity:
        podAntiAffinity:
          # Use preferredDuringScheduling to allow rolling updates
          # With 3 replicas and 3 nodes, requiredDuringScheduling blocks new pods during updates
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app.kubernetes.io/name: loki
                topologyKey: kubernetes.io/hostname

    service:
      app:
        controller: loki
        ports:
          http:
            port: *port

    serviceMonitor:
      app:
        endpoints:
          - port: http

    persistence:
      config-file:
        type: configMap
        name: loki-configmap
        globalMounts:
          - path: /etc/loki/config.yaml
            subPath: loki.yaml
      rules:
        type: configMap
        name: loki-rules
        globalMounts:
          # Loki multi-tenancy: when auth_enabled=false, the default tenant is "fake".
          # Loki reads rules from <directory>/<tenant>, so we mount into /etc/loki/rules/fake.
          - path: /etc/loki/rules/fake
      data:
        enabled: true
        type: emptyDir
        globalMounts:
          - path: /var/loki
      tmp:
        enabled: true
        type: emptyDir
        globalMounts:
          - path: /tmp


