---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: loki
spec:
  chartRef:
    kind: OCIRepository
    name: loki
  interval: 1h
  values:
    fullnameOverride: loki

    controllers:
      loki:
        # RWO PVC: avoid multi-attach during rollouts.
        strategy: Recreate
        annotations:
          reloader.stakater.com/auto: "true"
        containers:
          app:
            image:
              repository: docker.io/grafana/loki
              tag: 3.6.3
            args:
              - -target=all
              - -config.file=/etc/loki/config.yaml
              - -config.expand-env=true
            envFrom:
              - secretRef:
                  name: loki-secret
            probes:
              liveness: &probes
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /ready
                    port: &port 3100
              readiness: *probes
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities:
                drop:
                  - ALL
            resources:
              requests:
                cpu: 100m
                memory: 512Mi
              limits:
                memory: 1Gi

    defaultPodOptions:
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch

    service:
      app:
        controller: loki
        ports:
          http:
            port: *port

    serviceMonitor:
      app:
        endpoints:
          - port: http

    persistence:
      config-file:
        type: configMap
        name: loki-configmap
        globalMounts:
          - path: /etc/loki/config.yaml
            subPath: loki.yaml
      rules:
        type: configMap
        name: loki-rules
        globalMounts:
          # Loki multi-tenancy: when auth_enabled=false, the default tenant is "fake".
          # Loki reads rules from <directory>/<tenant>, so we mount into /etc/loki/rules/fake.
          - path: /etc/loki/rules/fake
      data:
        enabled: true
        type: persistentVolumeClaim
        storageClass: ceph-rbd
        accessMode: ReadWriteOnce
        size: 20Gi
        globalMounts:
          - path: /var/loki
      tmp:
        enabled: true
        type: emptyDir
        globalMounts:
          - path: /tmp


