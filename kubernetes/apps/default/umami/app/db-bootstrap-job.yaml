---
apiVersion: batch/v1
kind: Job
metadata:
  name: umami-db-bootstrap
  labels:
    app.kubernetes.io/name: umami-db-bootstrap
spec:
  backoffLimit: 3
  template:
    metadata:
      labels:
        app.kubernetes.io/name: umami-db-bootstrap
    spec:
      restartPolicy: OnFailure
      containers:
        - name: bootstrap
          image: docker.io/library/postgres:16
          imagePullPolicy: IfNotPresent
          env:
            - name: PGHOST
              value: postgres-rw.postgresql-system.svc.cluster.local
            - name: PGPORT
              value: "5432"
            - name: PGUSER
              valueFrom:
                secretKeyRef:
                  name: umami-postgres-superuser
                  key: username
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: umami-postgres-superuser
                  key: password
            - name: APP_DB_NAME
              valueFrom:
                secretKeyRef:
                  name: umami-config
                  key: DB_NAME
            - name: APP_DB_USER
              valueFrom:
                secretKeyRef:
                  name: umami-config
                  key: DB_USER
            - name: APP_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: umami-config
                  key: DB_PASSWORD
          command:
            - /bin/sh
            - -c
            - |
              set -euo pipefail

              psql \
                -v ON_ERROR_STOP=1 \
                -v APP_DB_NAME="$APP_DB_NAME" \
                -v APP_DB_USER="$APP_DB_USER" \
                -v APP_DB_PASSWORD="$APP_DB_PASSWORD" \
                "postgresql://$PGUSER:$PGPASSWORD@$PGHOST:$PGPORT/postgres" <<'SQL'
              SELECT CASE
                WHEN EXISTS (SELECT 1 FROM pg_roles WHERE rolname = :'APP_DB_USER') THEN
                  format('ALTER ROLE %I WITH LOGIN PASSWORD %L', :'APP_DB_USER', :'APP_DB_PASSWORD')
                ELSE
                  format('CREATE ROLE %I LOGIN PASSWORD %L', :'APP_DB_USER', :'APP_DB_PASSWORD')
              END\gexec
              SQL

              psql \
                -v ON_ERROR_STOP=1 \
                -v APP_DB_NAME="$APP_DB_NAME" \
                -v APP_DB_USER="$APP_DB_USER" \
                "postgresql://$PGUSER:$PGPASSWORD@$PGHOST:$PGPORT/postgres" <<'SQL'
              SELECT format('CREATE DATABASE %I OWNER %I ENCODING ''UTF8''', :'APP_DB_NAME', :'APP_DB_USER')
              WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = :'APP_DB_NAME')\gexec
              SQL

              psql \
                -v ON_ERROR_STOP=1 \
                -v APP_DB_NAME="$APP_DB_NAME" \
                -v APP_DB_USER="$APP_DB_USER" \
                "postgresql://$PGUSER:$PGPASSWORD@$PGHOST:$PGPORT/postgres" <<'SQL'
              SELECT format('GRANT ALL PRIVILEGES ON DATABASE %I TO %I', :'APP_DB_NAME', :'APP_DB_USER')\gexec
              SQL

