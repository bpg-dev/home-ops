---
# yaml-language-server: $schema=https://raw.githubusercontent.com/yannh/kubernetes-json-schema/master/master-standalone-strict/cronjob-batch-v1.json
# CronJob for restoring paperless-ngx documents from backup
# Uses document_importer to import documents, thumbnails, and metadata
# IMPORTANT: This job is suspended by default - enable manually when needed
# Schedule: Daily at 22:36 (10:36 PM) - but suspended
apiVersion: batch/v1
kind: CronJob
metadata:
  name: paperless-restore
spec:
  concurrencyPolicy: Forbid
  failedJobsHistoryLimit: 2
  schedule: "36 22 * * *"  # Daily at 10:36 PM
  suspend: true  # Suspended by default - enable manually when restore is needed
  successfulJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          automountServiceAccountToken: true
          serviceAccountName: default
          containers:
            - name: restore
              command:
                - /bin/bash
                - -c
              args:
                - |
                  cd /usr/src/paperless/src
                  python3 manage.py document_importer /backup
              image: ghcr.io/paperless-ngx/paperless-ngx:2.20.9
              env:
                - name: PAPERLESS_DATA_DIR
                  value: /library/data
                - name: PAPERLESS_MEDIA_ROOT
                  value: /library/media
                - name: PAPERLESS_SRC_DIR
                  value: /usr/src/paperless/src
                - name: PAPERLESS_REDIS
                  value: redis://dragonfly.dragonfly-system.svc.cluster.local:6379
              envFrom:
                - secretRef:
                    name: paperless-secret
              ports: []
              resources:
                requests:
                  cpu: 100m
                  memory: 256Mi
                limits:
                  memory: 512Mi
              volumeMounts:
                - mountPath: /backup
                  name: backup
                - mountPath: /library
                  name: library
              securityContext:
                runAsUser: 1000
                runAsGroup: 1000
          restartPolicy: Never
          volumes:
            - name: backup
              nfs:
                server: nas.internal
                path: /mnt/tank/nfs/paperless-backup
            - name: library
              persistentVolumeClaim:
                claimName: paperless-ngx

