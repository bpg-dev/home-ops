---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: paperless-ngx
spec:
  chartRef:
    kind: OCIRepository
    name: paperless-ngx
  interval: 1h
  values:
    controllers:
      paperless-ngx:
        type: statefulset
        strategy: RollingUpdate
        annotations:
          reloader.stakater.com/auto: "true"
        initContainers:
          01-init-db:
            image:
              repository: ghcr.io/onedr0p/postgres-init
              tag: 17.4
            envFrom:
              - secretRef:
                  name: paperless-secret
        containers:
          # NOTE: Container-level security contexts are NOT used for paperless-ngx containers
          # because the s6-overlay init system requires privileges to fix /run permissions.
          # Pod-level security context (runAsUser: 1000, fsGroup: 1000) is sufficient.
          # Adding allowPrivilegeEscalation: false and dropping ALL capabilities breaks startup.
          main:
            dependsOn: [gotenberg, tika]
            image:
              repository: ghcr.io/paperless-ngx/paperless-ngx
              tag: 2.20.9
            env:
              # PAPERLESS_ALLOWED_HOSTS: paperless.${SECRET_DOMAIN}
              PAPERLESS_CONSUMER_POLLING: 60
              PAPERLESS_CONSUMER_RECURSIVE: "true"
              PAPERLESS_CONSUMER_SUBDIRS_AS_TAGS: "true"
              PAPERLESS_CONSUMPTION_DIR: /consume
              PAPERLESS_DATA_DIR: /library/data
              PAPERLESS_ENABLE_HTTP_REMOTE_USER: "true"
              PAPERLESS_EXPORT_DIR: /library/export
              PAPERLESS_HTTP_REMOTE_USER_HEADER_NAME: HTTP_REMOTE_USER
              PAPERLESS_MEDIA_ROOT: /library/media
              PAPERLESS_OCR_LANGUAGE: eng
              PAPERLESS_PORT: &port 80
              PAPERLESS_REDIS: redis://dragonfly.dragonfly-system:6379
              PAPERLESS_TASK_WORKERS: 2
              PAPERLESS_TIKA_ENABLED: 1
              PAPERLESS_TIKA_GOTENBERG_ENDPOINT: http://localhost:3000
              PAPERLESS_TIKA_ENDPOINT: http://localhost:9998
              PAPERLESS_TIME_ZONE: UTC
              PAPERLESS_TRUSTED_PROXIES: 10.42.0.0/16,192.168.1.0/24
              PAPERLESS_URL: https://paperless.${SECRET_DOMAIN}
              # SSO
              PAPERLESS_ENABLE_ALLAUTH: "true"
              PAPERLESS_APPS: "allauth.socialaccount.providers.openid_connect"
              PAPERLESS_AUTO_LOGIN: "true"
              PAPERLESS_AUTO_CREATE: "true"
              PAPERLESS_LOGOUT_REDIRECT_URL: "https://sso.${SECRET_DOMAIN}/application/o/paperless-ngx/end-session/"
              PAPERLESS_REDIRECT_LOGIN_TO_SSO: "true"
              PAPERLESS_DISABLE_REGULAR_LOGIN: "true"
              PAPERLESS_SOCIAL_AUTO_SIGNUP: "true"
              PAPERLESS_SOCIALACCOUNT_ALLOW_SIGNUPS: "true"
              PAPERLESS_SOCIAL_ACCOUNT_SYNC_GROUPS: "true"
              # User mapping
              USERMAP_UID: 1000
              USERMAP_GID: 1000
            envFrom:
              - secretRef:
                  name: paperless-secret
            probes:
              liveness: &probes
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /api/
                    port: *port
              readiness: *probes
            resources:
              requests:
                cpu: 100m
                memory: 2Gi
              limits:
                memory: 4Gi
          backup:
            image:
              repository: ghcr.io/paperless-ngx/paperless-ngx
              tag: 2.20.9
            command:
              - /bin/bash
              - -c
            args:
              - |
                set -euo pipefail
                # Backup schedule: Daily at 22:36 (10:36 PM)
                BACKUP_HOUR=22
                BACKUP_MINUTE=36
                LAST_BACKUP_FILE=/tmp/last_backup_timestamp

                # Function to run backup
                run_backup() {
                  local timestamp=$(date +%Y%m%d%H%M)
                  echo "[$(date +%Y-%m-%d\ %H:%M:%S)] Starting paperless-ngx backup..."
                  cd /usr/src/paperless/src
                  if python3 manage.py document_exporter --use-folder-prefix --compare-checksums --no-color --skip-checks /backup; then
                    echo "$timestamp" > "$LAST_BACKUP_FILE"
                    echo "[$(date +%Y-%m-%d\ %H:%M:%S)] Backup completed successfully"
                  else
                    echo "[$(date +%Y-%m-%d\ %H:%M:%S)] Backup failed with exit code $?"
                    return 1
                  fi
                }

                # Wait for main container to be ready (check if database is accessible)
                echo "[$(date +%Y-%m-%d\ %H:%M:%S)] Waiting for paperless-ngx to be ready..."
                max_wait=300
                waited=0
                while [ $waited -lt $max_wait ]; do
                  if python3 -c "import os; os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'paperless.settings'); import django; django.setup(); from django.db import connection; connection.ensure_connection()" 2>/dev/null; then
                    echo "[$(date +%Y-%m-%d\ %H:%M:%S)] Paperless-ngx is ready"
                    break
                  fi
                  sleep 5
                  waited=$((waited + 5))
                done

                # Main loop - check every minute if it's time to backup
                while true; do
                  current_hour=$(date +%H)
                  current_minute=$(date +%M)
                  current_timestamp=$(date +%Y%m%d%H%M)

                  # Check if it's backup time and we haven't backed up in this minute
                  if [ "$current_hour" -eq "$BACKUP_HOUR" ] && [ "$current_minute" -eq "$BACKUP_MINUTE" ]; then
                    last_backup=$(cat "$LAST_BACKUP_FILE" 2>/dev/null || echo "0")
                    if [ "$current_timestamp" != "$last_backup" ]; then
                      run_backup
                    fi
                  fi

                  # Sleep for 60 seconds before next check
                  sleep 60
                done
            env:
              - name: PAPERLESS_DATA_DIR
                value: /library/data
              - name: PAPERLESS_MEDIA_ROOT
                value: /library/media
              - name: PAPERLESS_SRC_DIR
                value: /usr/src/paperless/src
              - name: PAPERLESS_REDIS
                value: redis://dragonfly.dragonfly-system:6379
              - name: TZ
                value: UTC
            envFrom:
              - secretRef:
                  name: paperless-secret
            resources:
              requests:
                cpu: 100m
                memory: 256Mi
              limits:
                memory: 512Mi
          gotenberg:
            image:
              repository: gotenberg/gotenberg
              tag: 8.27.0
            command:
              - gotenberg
            args:
              - "--chromium-disable-javascript=true"
              - "--chromium-allow-list=file:///tmp/.*"
              - "--api-timeout=60s"
            env:
              - name: HOME
                value: /tmp
            resources:
              requests:
                cpu: 100m
                memory: 512Mi
              limits:
                memory: 2Gi
          tika:
            image:
              repository: docker.io/apache/tika
              tag: 3.2.3.0-full
            resources:
              requests:
                cpu: 50m
                memory: 256Mi
              limits:
                memory: 1Gi
    defaultPodOptions:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
    service:
      main:
        ports:
          http:
            port: *port
    route:
      main:
        hostnames: ["paperless.${SECRET_DOMAIN}"]
        parentRefs:
          - name: envoy-internal
            namespace: network
            sectionName: https
        rules:
          - backendRefs:
              - identifier: main
                port: *port
    persistence:
      library:
        enabled: true
        type: persistentVolumeClaim
        storageClass: ceph-rbd
        size: "100Gi"
        retain: true
        accessMode: ReadWriteOnce
        advancedMounts:
          paperless-ngx:
            main:
              - path: /library
            backup:
              - path: /library
      backup:
        enabled: true
        type: nfs
        server: nas.internal
        path: /mnt/tank/nfs/paperless-backup
        globalMounts:
          - path: /backup
      consume:
        enabled: true
        type: nfs
        server: nas.internal
        path: /mnt/tank/scanner
        globalMounts:
          - path: /consume
      run-tmpfs:
        enabled: true
        type: emptyDir
        globalMounts:
          - path: /run
    resources:
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        memory: 4Gi
