---
# CronJob for backing up paperless-ngx documents
# DEPRECATED: Backup is now handled by a sidecar container in the StatefulSet
# This CronJob is suspended and kept for reference only
# Uses document_exporter to export all documents, thumbnails, and metadata
# Schedule: Daily at 22:36 (10:36 PM)
# yaml-language-server: $schema=https://raw.githubusercontent.com/yannh/kubernetes-json-schema/master/v1.30.0/cronjob.json
apiVersion: batch/v1
kind: CronJob
metadata:
  name: paperless-backup
spec:
  concurrencyPolicy: Forbid
  failedJobsHistoryLimit: 2
  schedule: "36 22 * * *"  # Daily at 10:36 PM
  suspend: true  # Suspended - backup now runs as sidecar
  successfulJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          automountServiceAccountToken: true
          serviceAccountName: default
          containers:
            - name: backup
              command:
                - /bin/bash
                - -c
              args:
                - |
                  cd /usr/src/paperless/src
                  python3 manage.py document_exporter --use-folder-prefix --compare-checksums --no-color --skip-checks /backup
              image: ghcr.io/paperless-ngx/paperless-ngx:2.20.1
              env:
                - name: PAPERLESS_DATA_DIR
                  value: /library/data
                - name: PAPERLESS_MEDIA_ROOT
                  value: /library/media
                - name: PAPERLESS_SRC_DIR
                  value: /usr/src/paperless/src
                - name: PAPERLESS_REDIS
                  value: redis://dragonfly.dragonfly-system.svc.cluster.local:6379
              envFrom:
                - secretRef:
                    name: paperless-secret
              ports: []
              resources:
                requests:
                  cpu: 100m
                  memory: 512Mi
                limits:
                  memory: 2Gi
              volumeMounts:
                - mountPath: /backup
                  name: backup
                - mountPath: /library
                  name: library
              securityContext:
                runAsUser: 1000
                runAsGroup: 1000
          restartPolicy: Never
          volumes:
            - name: backup
              nfs:
                server: nas.internal
                path: /mnt/tank/nfs/paperless-backup
            - name: library
              persistentVolumeClaim:
                claimName: paperless-ngx

