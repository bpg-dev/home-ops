---
# Job to create the database and user in PostgreSQL
# This job runs once to bootstrap the database
apiVersion: batch/v1
kind: Job
metadata:
  name: paperless-db-init
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: init-db
          image: postgres:16-alpine
          envFrom:
            - secretRef:
                name: paperless-db-credentials
            - secretRef:
                name: postgres-superuser
                namespace: postgresql-system
          env:
            - name: PGHOST
              valueFrom:
                secretKeyRef:
                  name: paperless-db-credentials
                  key: DB_HOST
            - name: PGPORT
              valueFrom:
                secretKeyRef:
                  name: paperless-db-credentials
                  key: DB_PORT
            - name: PGDATABASE
              value: postgres
            - name: PGUSER
              valueFrom:
                secretKeyRef:
                  name: postgres-superuser
                  namespace: postgresql-system
                  key: username
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-superuser
                  namespace: postgresql-system
                  key: password
          command:
            - /bin/sh
            - -c
            - |
              set -e
              echo "Creating database and user..."
              psql -v ON_ERROR_STOP=1 <<-EOSQL
                -- Create database if it doesn't exist
                SELECT 'CREATE DATABASE ' || quote_ident('$DB_NAME')
                WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = '$DB_NAME')\gexec

                -- Create user if it doesn't exist
                DO \$\$
                BEGIN
                  IF NOT EXISTS (SELECT FROM pg_user WHERE usename = '$DB_USER') THEN
                    CREATE USER $DB_USER WITH PASSWORD '$DB_PASSWORD';
                  ELSE
                    ALTER USER $DB_USER WITH PASSWORD '$DB_PASSWORD';
                  END IF;
                END
                \$\$;

                -- Grant privileges
                GRANT ALL PRIVILEGES ON DATABASE $DB_NAME TO $DB_USER;

                -- Connect to the new database and grant schema privileges
                \c $DB_NAME
                GRANT ALL ON SCHEMA public TO $DB_USER;
                ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO $DB_USER;
                ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO $DB_USER;
              EOSQL
              echo "Database and user created successfully!"

